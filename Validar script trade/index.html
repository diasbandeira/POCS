<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validar script trade.programafeedback.com.br</title>
    <script>
        //var obj = {"multiregisters":[{"codigo":"24991cf4-3adf-4b99-4e95-e150f9079334","periodo":"20220527090700","visita":"FBPDV-2022-90068","finished":"27/05/2022 09:10:44","rede":"EPA","pdv":"EPA PLUS VENDA NOVA - LOJA 38","cliente":"ZINHO","promotor":"SAULO SANDER SILVA","produto":"BAGUETE ZINHO TRADICIONAL 300G","tipoOcorrencia":"Vencimento menor que 90 dias","quantidade":"45","vencimento":"03/08/2022","precoVarejo":"11,58","precoAtacado":"11,58","local":"No Ponto Natural","acao":"Permaneceu no Ponto Natural"},{"codigo":"59e53764-85a3-eb69-8aea-874564c10a36","periodo":"20220527090744","visita":"FBPDV-2022-90068","finished":"27/05/2022 09:10:44","rede":"EPA","pdv":"EPA PLUS VENDA NOVA - LOJA 38","cliente":"ZINHO","promotor":"SAULO SANDER SILVA","produto":"BAGUETE ZINHO PICANTE 300G","tipoOcorrencia":"Vencimento menor que 90 dias","quantidade":"14","vencimento":"29/06/2022","precoVarejo":"11,58","precoAtacado":"11,58","local":"No Ponto Natural","acao":"Permaneceu no Ponto Natural"},{"codigo":"ad30ba23-89c3-11bf-8340-97583ef9ce88","periodo":"20220527090825","visita":"FBPDV-2022-90068","finished":"27/05/2022 09:10:44","rede":"EPA","pdv":"EPA PLUS VENDA NOVA - LOJA 38","cliente":"ZINHO","promotor":"SAULO SANDER SILVA","produto":"BOLINHA ZINHO TRADICIONAL 300G","tipoOcorrencia":"Vencimento menor que 90 dias","quantidade":"22","vencimento":"03/08/2022","precoVarejo":"11,58","precoAtacado":"11,58","local":"No Ponto Natural","acao":"Permaneceu no Ponto Natural"},{"codigo":"24799728-e54a-185b-c9ab-337f0e30a9af","periodo":"20220527090830","visita":"FBPDV-2022-90068","finished":"27/05/2022 09:10:44","rede":"EPA","pdv":"EPA PLUS VENDA NOVA - LOJA 38","cliente":"ZINHO","promotor":"SAULO SANDER SILVA","produto":"BOLINHA ZINHO C/ CATUPIRY 300G","tipoOcorrencia":"Em Ruptura","quantidade":"0","vencimento":"","precoVarejo":"","precoAtacado":"","local":"","acao":""}]};
        var obj = [
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "212d1505-a123-104b-1d36-5807de503434",
            "produto": "AMASSADOR DE BATATAS MIMO STYLE ASA1309 - REF:4488",
            "periodo": "20220822113323",
            "rupturaGondola": true,
            "ruptura": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "335fc61c-0c87-0c90-cf6d-7d42630b95c8",
            "produto": "ASSADEIRA DE PIZZA LUMIERE MIMO STYLE ASS1308 - REF:4853",
            "periodo": "20220822113323",
            "rupturaLoja": true,
            "ruptura": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "d8392b72-4378-045a-4a85-5504c55ae8b4",
            "produto": "BANDEJA OVAL ECOKITCHEN 24X11CM MIMO STYLE BM19132 - REF:6544",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "fa08b94d-4cb7-df74-548a-34c771e1a29c",
            "produto": "BATEDOR DE OVOS G FUET MIMO STYLE ASA7 B - REF:452",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "e030f8e2-7880-93f2-5102-37f3eaf7f3f0",
            "produto": "CANUDOS REUTILIZAVEIS 4 ESPON MIMO STYLE AC19024 - REF:6447",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "51ef7a22-1306-6877-3c39-1b8bed115816",
            "produto": "COLHER DE SILICONE VERMELHA MIMO STYLE SN1737 - REF:5911",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "fa12a9d6-0e56-b991-325f-a01425c62b82",
            "produto": "COLHER PARA ARROZ MIMO STYLE ASA2 - REF:397",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "d093fbad-f534-7432-93c0-2ca9e22af6c7",
            "produto": "COLHER PARA SORVETE MIMO STYLE ASA13 - REF:390",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "85198b3e-0e9c-469b-c990-261fa1b5f5a9",
            "produto": "CONCHA MIMO STYLE ASA1 - REF:386",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "f6f61b81-5776-6429-d635-b571bd6dda07",
            "produto": "CORTADOR DE PIZZA MIMO STYLE ASA14 - REF:391",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "6b991465-cf8e-a8ac-e8c6-e0d6a6f38afd",
            "produto": "FORMA P/ 6 CUPCAKES LUMIERE MIMO STYLE ASS1307 - REF:4852",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "9f5a5b80-9bb2-4c44-f162-0471b95da2db",
            "produto": "KIT DE UTENSILIOS 5 PECAS ECOKITC MIMO STYLE BM1503 - REF:5482",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "dd238690-64f7-7a65-4d8a-9ebb3a6af307",
            "produto": "MOEDOR MADEIRA MIMO STYLE AMD1722 20CM - REF:5894",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "64bbc9d3-bd7a-45fb-e234-b540bbdd52c9",
            "produto": "PEGADOR DE SALADA MIMO STYLE ASA25 - REF:403",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "71b228b6-615e-a473-39d4-46438f5d945a",
            "produto": "PENEIRA EM ACO INOX 10 CM MIMO STYLE AP10 - REF:361",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "623d0ca5-e42c-6bc7-6ac6-a6933d25e602",
            "produto": "PENEIRA EM ACO INOX 16 CM MIMO STYLE AP16 - REF:363",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "3db3d257-554d-a927-6acb-4033e4391b1e",
            "produto": "PORTA FRIOS C/ TAMPA ECOKTICHEN MIMO STYLE BM19161 - REF:6682",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "1fd98f0a-4320-1fdd-8939-052d59d8b136",
            "produto": "PORTA QUEIJO C/ TAMPA ECOKITCHEN MIMO STYLE BM1502 - REF:5480",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "c0157d8b-094d-8281-36e1-40b8ac221236",
            "produto": "SCUMADEIRA MIMO STYLE ASA3 - REF:409",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "7d0fc424-a0c6-419a-f961-1e9d57d63a92",
            "produto": "SOCADOR ECOKITCHEN MIMO STYLE BM1500 - REF:5474",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "813f9946-5dc9-93f9-68e3-cc4bb440b6d0",
            "produto": "TESOURA PARA FRANGO 20CM MIMO STYLE ASA46 - REF:428",
            "periodo": "20220822113323",
            "presenca": true
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "f6e84f3b-973d-db83-2684-45506cad5ed2",
            "produto": "BOWL MELAMINA AZULEJO PORT MIMO STYLE MB19A - REF:7066",
            "periodo": "20220822113323",
            "reposicao": true,
            "qtdReposicao": 1.0,
            "caixas": "1"
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "0f185bfc-c6d7-66d0-8c46-c03c3e875580",
            "produto": "JOGO DE ESPATULAS INOX 4 PECAS MIMO STYLE AC19262 - REF:6906",
            "periodo": "20220822113323",
            "reposicao": true,
            "qtdReposicao": 1.0,
            "caixas": "1"
        },
        {
            "visita": "FBPDV-2022-764200",
            "rede": "SUPERMERCADOS BH",
            "cliente": "MIMOSTYLE-569",
            "tipoPDV": "Canal Alimentar",
            "pdv": "BH ALVORADA - LOJA 217",
            "cnpjPDV": "04641376022610",
            "codigo": "6b415846-271a-06d2-eb5c-592402cfea1d",
            "produto": "JOGO GARFOS P/ PETISCO INOX 4PC MIMO STYLE AC19261 - REF:6905",
            "periodo": "20220822113323",
            "reposicao": true,
            "qtdReposicao": 1.0,
            "caixas": "1"
        }
    ] 
        //console.log("obj: ", obj);

function getData(dados, filters) {
  var produtos = {};

  dados.forEach(function (kpi) {
    
    if(filters['data'] === undefined || filters['data'] === kpi.produto){
      
      var produto = produtos[kpi._id] || {
        ruptura: false,
        rupturaLoja: false,
        rupturaGondola: false,
        rede: '',
        pdv: '',
        produto: '',
        tipo: '',
        visita: '',
        sort: parseInt(kpi._ref)
      };
      
      produto.id = kpi._id;
      produto.periodo = kpi._ref;
      produto.rede = kpi.rede;
      produto.tipo = kpi.tipoPDV;
      produto.produto = kpi.produto;
      produto.pdv = kpi.pdv;
      produto.visita = kpi.visita;
      produto.ruptura = produto.ruptura || !!kpi.ruptura;
      produto.rupturaLoja = produto.rupturaLoja || !!kpi.rupturaLoja;
      produto.rupturaGondola = produto.rupturaGondola || !!kpi.rupturaGondola;
      console.log('produto: ' , produto)
      produtos[kpi._id] = produto;

      //console.log('produtos: ', produtos[kpi._id])
    }
  
  });


console.log('produtos: ', produtos)
  var items = Object.keys(produtos).map(function (key) {
    return produtos[key];
  }).filter(function (prd) {
    return prd.ruptura;
  }).sort(function (o1, o2) {
    return o1.sort - o2.sort;
  });
  var labels = {};
  var series = ['Ruptura em Gôndola', 'Ruptura em Loja'];
  var config = [];
  var colors = ['#D50000', '#222222'];
  var headers = ['ID', 'PERIODO', 'REDE', 'PDV', 'PRODUTO', 'STATUS'];
  console.log("items: " , items)
  for (var index in items) {
    var produto = items[index];
    var periodo = produto.periodo;
    var label = labels[periodo] || {
      data: [0, 0],
      details: [
        [],
        []
      ]
    };
    if (produto.rupturaGondola) {
      label.data[0]++;
      label.details[0].push([produto.id, periodo, produto.rede, produto.pdv, produto.produto, 'ESTOCADO E NÃO EXPOSTO']);
    } else if (produto.rupturaLoja) {
      label.data[1]++;
      label.details[1].push([produto.id, periodo, produto.rede, produto.pdv, produto.produto, 'RUPTURA EM LOJA']);
    }
    labels[periodo] = label;
  }
  var data = [
    [],
    []
  ];
  var color = 0;
  var colorArray = [];
  var details = [];
  for (var index in labels) {
    var label = labels[index];
    details.push(label.details);
    data[0].push((((label.data[0] / (label.data[0] + label.data[1]) * 100) * 100) / 100).toFixed(2));
    data[1].push((100 - (((label.data[0] / (label.data[0] + label.data[1]) * 100) * 100) / 100)).toFixed(2));
    if (colors.length <= ++color) {
      color = 0;
    }
    colorArray.push(colors[color]);
    config.push({
      display: true,
      id: index,
      position: 'left',
      type: 'linear'
    });
  }
  return {
    config: config,
    data: data,
    headers: headers,
    details: details,
    labels: Object.keys(labels),
    series: series,
    colors: colorArray
  };
}
//var chart = getChart();
//var params = getParams();


var data = getData(obj, 'params.filters');

console.log('data: ', data);
        
    </script>
</head>
<body>
    
</body>
</html>